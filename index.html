<!DOCTYPE html>
<html>
<head>
	<script src="airtable.browser.js"></script>
	<script src="https://static.airtable.com/js/embed/embed_snippet_v1.js"></script>
	<!-- <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script> -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

	<!-- <script type="text/javascript" src="bike_project_navigator.js"></script> -->
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->

	<style>
		.selected {
		    color: black;
		}
		.notSelected {
		    color: grey;
		}
		.title {
		    font-weight: bold;
		}
	</style>
</head>

<body>
	<div style="font-size: 2vw">
		<a class="title"> Outcome: </a> </br>
		Establish bicycling as a safe and common transportation method in the United States
	</div>
	<div>
		<span>
			<ul id="whatList"  style="list-style-type: none; display: inline-block;  font-size: 2vw; vertical-align: top;"> 
			</ul>
			<ul id="howList"  style="list-style-type: none; display: inline-block; font-size: 2vw; vertical-align: top;"> 
			</ul>
		</span>
	</div>
	<div>
		<span>
			<ul id="effortList"  style="list-style-type: none; display: inline-block; font-size: 1vw; vertical-align: top;"> 
			</ul>
			<ul id="mediaList"  style="list-style-type: none; display: inline-block; font-size: 1vw; vertical-align: top;"> 
			</ul>
		</span>
	</div>
	
 <div id="accordion" style="width: 50%; height: 500px; ">
            <h3>Add a new effort</h3>
            <div style="width: 100%; height: 500px;">
                <iframe name="I1" id="I1" data-src="https://airtable.com/embed/shrkkmCJlmRWY3drd?backgroundColor=gray" frameborder="0"  width="100%" height="100%" scrolling="no">
                </iframe>   
            </div>
            <h3>Add a new story/article</h3>
            <div style="width: 100%; height: 500px;">
                <iframe name="I2" id="I2" data-src="https://airtable.com/embed/shrQb3TwZJ2dWlCH9?backgroundColor=gray" frameborder="0" width="100%" height="100%" scrolling="no"></iframe> 
            </div>
        </div>

	<div style="  height:30px;  padding:5px; bottom:0px;">
		Created by Scott Owades.
		<a href="https://airtable.com/shrK4deyUvmUA9rcJ"> Source data (via Airtable) </a>

	</div>
</body>
<script type="text/javascript">

var Airtable = require('airtable');
// This is a read-only API key...don't get excited
var base = new Airtable({apiKey: 'keyt2DL8nfcAyl338'}).base('appVtB7KozrwvMKQm');

base('What').select({
    view: 'Grid view'
}).firstPage(function(err, records) {
    if (err) { console.error(err); return; }
    createTitle("Strategies:","whatList");
    records.forEach(function(record) {
        var what = record.get('What to do')
        var listPart = document.createElement("li");
        listPart.onclick = function() {
            return function(){
                showHows(what);
                const selectedElement = this.parentElement.getElementsByClassName('selected')
                const notSelectedElements = this.parentElement.children
                Array.from(selectedElement).forEach(item => item.classList.remove('selected')) 
                Array.from(notSelectedElements).forEach(item => item.classList.add('notSelected'))  
                this.classList.remove('notSelected');
                this.classList.add('selected');
            }
        }(what);
        var textNode = document.createTextNode(what);
        listPart.appendChild(textNode);
        document.getElementById("whatList").appendChild(listPart);
    });
});

function showHows(what) {
    document.getElementById("howList").textContent = ''
    document.getElementById("effortList").textContent = ''
    document.getElementById("mediaList").textContent = ''
    var filterFormula = "AND( {What} = '" + what + "', {Reviewed} = 'Yes')"
    base('How').select({
        view: 'Grid view',
        filterByFormula: filterFormula

    }).firstPage(function(err, records) {
        if (err) { console.error(err); return; }
    createTitle("Approaches:","howList");
        records.forEach(function(record) {
            var how = record.get('How')
            var listPart = document.createElement("li");
            listPart.onclick = function() {
                return function(){
                    showEfforts(how);
                    showMedia(how);
                    const selectedElement = this.parentElement.getElementsByClassName('selected')
                    const notSelectedElements = this.parentElement.children
                    Array.from(selectedElement).forEach(item => item.classList.remove('selected')) 
                    Array.from(notSelectedElements).forEach(item => item.classList.add('notSelected'))  
                    this.classList.remove('notSelected');
                    this.classList.add('selected');
                }
            }(how);
            var textNode = document.createTextNode(how);
            listPart.appendChild(textNode);
            document.getElementById("howList").appendChild(listPart);
        });
    });
}

function showEfforts(how) {
    document.getElementById("effortList").textContent = ''
    var filterFormula = "AND(SEARCH('"+ how + "',{How}) > 0, {Reviewed} = 'Yes')"
    base('Efforts').select({
        view: 'Grid view',
        filterByFormula: filterFormula
    }).firstPage(function(err, records) {
        if (err) { console.error(err); return; }
        createTitle("Efforts:","effortList");
        records.forEach(function(record) {
            var effort = record.get('Effort')
            var url = record.get('URL')
            var listPart = document.createElement("li");
            var a = document.createElement("a");
            a.textContent = effort;
            a.setAttribute('href', url);
            listPart.appendChild(a);
            document.getElementById("effortList").appendChild(listPart);
        });
    });
}
function showMedia(how) {
    document.getElementById("mediaList").textContent = ''
    var filterFormula = "AND( SEARCH('"+ how + "',{How}) > 0, {Reviewed} = 'Yes')"
    base('Media').select({
        view: 'Grid view',
        filterByFormula: filterFormula
    }).firstPage(function(err, records) {
        if (err) { console.error(err); return; }
        createTitle("Media:","mediaList");
        records.forEach(function(record) {
            var media = record.get('Media')
            var url = record.get('URL')
            var listPart = document.createElement("li");
            var a = document.createElement("a");
            a.textContent = media;
            a.setAttribute('href', url);
            listPart.appendChild(a);
            document.getElementById("mediaList").appendChild(listPart);
        });
    });
}

function createTitle(title,list) {
    var listPart = document.createElement("li");
    var textNode = document.createTextNode(title);
    listPart.appendChild(textNode);
    listPart.classList.add('title');
    document.getElementById(list).appendChild(listPart);
}

function showIframe(panel){		
	$('iframe', panel).each(function(){
		var iframe = $(this);
	    if(  iframe.attr('src')==undefined ) iframe.attr('src', iframe.data('src') );
	});
};

$(function() {
    //I believe these two functions will load all
	showIframe( $('#accordion div').eq(0)  );
	showIframe( $('#accordion div').eq(1)  );
	
    $( "#accordion" ).accordion({     
        collapsible: true,
        heightStyle: "content",
        active: false,
        animate: {        
            duration: 200,        
            down: {            
                easing: "easeOutBounce",            
                duration: 1000        
            }    
            
        },
         beforeActivate: function( event, ui ) {
         		showIframe(ui.newPanel);
         } 
        
    });  
}); 

</script>
</html>